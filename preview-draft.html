<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Valor Wave CMS — Draft Preview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- CMS + Site Theme Variables -->
    <link rel="stylesheet" href="themes.css" />

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 12px 18px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header h1 {
            font-size: 16px;
            margin: 0;
            font-weight: 600;
        }

        header .meta {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 2px;
        }

        #back-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        #back-btn:hover {
            background: var(--border);
        }

        #preview-frame {
            flex: 1;
            width: 100%;
            border: none;
        }
    </style>
</head>

<body class="theme-original">
    <header>
        <div>
            <h1>Draft Preview</h1>
            <div class="meta" id="preview-meta"></div>
        </div>
        <button id="back-btn">← Back to CMS</button>
    </header>

    <iframe id="preview-frame"></iframe>

    <script>
        const API_BASE = "https://cms-api.valorwaveentertainment.com";

        const params = new URLSearchParams(window.location.search);
        const draftPath = params.get("path"); // e.g. drafts/homepage-12345.json

        const backBtn = document.getElementById("back-btn");
        const previewFrame = document.getElementById("preview-frame");
        const previewMeta = document.getElementById("preview-meta");

        backBtn.addEventListener("click", () => {
            window.close();
        });

        /* ------------------------------------------------------------
           Apply CMS theme to this preview window
        ------------------------------------------------------------ */
        function applyCmsTheme() {
            const theme = localStorage.getItem("cms-theme") || "original";

            document.body.classList.remove(
                "theme-original",
                "theme-multicam",
                "theme-patriotic",
                "dark"
            );

            document.body.classList.add(`theme-${theme}`);
        }

        applyCmsTheme();

        /* ------------------------------------------------------------
           GitHub API (via Worker)
        ------------------------------------------------------------ */
        async function githubApiRequest(path, method = "GET", body = null, repoName = "Valorwave-CMS") {
            const res = await fetch(`${API_BASE}/api/github`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    path,
                    method,
                    body,
                    repo: repoName,
                    owner: "sammassengale82"
                })
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(`GitHub API error: ${res.status} — ${text}`);
            }

            return res.json();
        }

        /* ------------------------------------------------------------
           Load draft JSON → { html, timestamp }
        ------------------------------------------------------------ */
        async function loadDraft() {
            if (!draftPath) {
                alert("No draft path specified.");
                return;
            }

            try {
                const file = await githubApiRequest(draftPath, "GET", null, "Valorwave-CMS");
                const data = JSON.parse(atob(file.content));

                previewMeta.textContent = `Draft: ${draftPath} — ${data.timestamp || ""}`;

                // Create a blob URL for the HTML content
                const blob = new Blob([data.html], { type: "text/html" });
                const url = URL.createObjectURL(blob);
                previewFrame.src = url;

                previewFrame.onload = () => {
                    // Apply site theme inside the preview iframe
                    const siteTheme = localStorage.getItem("site-theme") || "original";
                    try {
                        previewFrame.contentWindow.postMessage(
                            { type: "set-theme", theme: siteTheme },
                            "*"
                        );
                    } catch (e) {
                        console.warn("Failed to send theme to preview iframe:", e);
                    }
                };
            } catch (e) {
                console.error(e);
                alert("Failed to load draft.");
            }
        }

        loadDraft();
    </script>
</body>
</html>
